name: Idempotent Release Notes
run-name: "Generated or Updated Release Notes on ${{ github.repository }} by ${{ github.actor }} with ${{ github.event_name }} (Attempt ${{ github.run_attempt }})"

on:
  pull_request:
    types:
      - reopened
      - opened
      - synchronize
#  issue_comment:
#    types: [created]
  workflow_dispatch:


permissions:
  contents: write

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}-release-notes-generator"
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:

  generate-running-release-notes:
    name: Detect Versions, Seed File, Inject Data
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          fetch-tags: true


      - name: Guard Branch
        id: branch-guard
        uses: ./.github/actions/feature-fail-fast


      - name: üîç Extract canonical component version and semantic tag
        id: version-info
        if: steps.branch-guard.outputs.feature == 'true'
        uses: ./.github/actions/extract-component-version-and-tag


      - name: Check and Seed Release Notes File
        if: steps.branch-guard.outputs.feature == 'true'
        id: seed-new
        uses: ./.github/actions/release-notes-create
        with:
          version: ${{ steps.version-info.outputs.version }}


      - name: Commit Release Notes Footer
        if: steps.branch-guard.outputs.feature == true && steps.append.outputs.changed == true
        uses: ./.github/actions/commit-and-push-files
        with:
          files: releases/v${{ steps.this-version.outputs.value }}.md
          message: "üìù Inject commits into release notes v${{ steps.this-version.outputs.value }}"


      - name: Extract all feature Commit Messages
        if: steps.branch-guard.outputs.feature == 'true'
        id: commit-log
        uses: ./.github/actions/release-notes-extract-commits


      - name: Extract all feature Changed Files
        if: steps.branch-guard.outputs.feature == 'true'
        id: file-log
        uses: ./.github/actions/release-notes-extract-files-changed


      - name: Write Logs and Files into Release Notes
        if: steps.branch-guard.outputs.feature == 'true'
        id: append
        uses: ./.github/actions/release-notes-write-notes
        with:
          version: ${{ steps.version-info.outputs.version }}
          comments: ${{ steps.commit-log.outputs.commits }}
          files: ${{ steps.file-log.outputs.files }}


      - name: Commit Release Notes Footer
        if: steps.branch-guard.outputs.feature == true && steps.append.outputs.changed == true
        uses: ./.github/actions/commit-and-push-files
        with:
          files: releases/v${{ steps.this-version.outputs.value }}.md
          message: "üìù Inject commits into release notes v${{ steps.this-version.outputs.value }}"


      - name: Detected Changes
        if: steps.branch-guard.outputs.feature == 'true' && steps.append.outputs.changed == 'true'
        run: echo "::notice title=Release Notes Footer Changes::${{steps.append.outputs.diff }}"