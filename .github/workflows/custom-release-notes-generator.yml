name: Idempotent Release Notes
run-name: "Generated or Updated Release Notes on ${{ github.repository }} by ${{ github.actor }} with ${{ github.event_name }} (Attempt ${{ github.run_attempt }})"

on:
  pull_request:
    types:
      - reopened
      - opened
      - synchronize
#  issue_comment:
#    types: [created]
  workflow_dispatch:


permissions:
  contents: write

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}-release-notes-generator"
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:

  generate-running-release-notes:
    name: Detect Versions, Seed File, Inject Data
    runs-on: ubuntu-latest

    steps:

      - name: Guard Branch
        id: branch-guard
        uses: ./.github/actions/feature-fail-fast


      - name: Checkout Repository
        uses: actions/checkout@v4.2.2
        if: steps.branch-guard.outputs.feature == true
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Extract Version from gradle.properties
        id: version
        if: steps.branch-guard.outputs.feature == true
        run: |
          VERSION=$(grep '^version=' gradle.properties | cut -d'=' -f2)
          echo "value=$VERSION" >> $GITHUB_OUTPUT
          echo "::notice title=Detected Target Version::$VERSION"

      - name: Check and Seed Release Notes File
        if: steps.branch-guard.outputs.feature == true
        id: seed-new
        uses: ./.github/actions/release-notes-create
        with:
          version: ${{ steps.version.outputs.value }}

      - name: Commit New Release Notes File (if created)
        if: steps.seed-new.outputs.created == 'true'
        uses: ./.github/actions/release-notes-commit
        with:
          version: ${{ steps.version.outputs.value }}
          message: "📝 Seed release notes for v${{ steps.version.outputs.value }}"

      - name: Extract all feature Commit Messages
        if: steps.branch-guard.outputs.feature == true
        id: commit-log
        uses: ./.github/actions/release-notes-extract-commits

      - name: Extract all feature Changed Files
        if: steps.branch-guard.outputs.feature == true
        id: file-log
        uses: ./.github/actions/release-notes-extract-files-changed


      - name: Write Logs and Files into Release Notes
        if: steps.branch-guard.outputs.feature == true
        id: append
        uses: ./.github/actions/release-notes-write-notes
        with:
          version: ${{ steps.version.outputs.value }}
          comments: ${{ steps.commit-log.outputs.commits }}
          files: ${{ steps.file-log.outputs.files }}

      - name: Commit Injection File
        if: steps.branch-guard.outputs.feature == true && steps.append.outputs.changed == true
        uses: ./.github/actions/release-notes-commit
        with:
          version: ${{ steps.version.outputs.value }}
          message: "📝 Inject commits into release notes v${{ steps.version.outputs.value }}"

      - name: Detected Changes
        if: steps.branch-guard.outputs.feature == true && steps.append.outputs.changed == true
        run: echo "::notice title=Release Notes Footer Changes::${{steps.append.outputs.diff }}"